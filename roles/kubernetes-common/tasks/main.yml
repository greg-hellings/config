- name: install repository
  yum_repository:
    deltarpm_percentage: 0
    gpgcheck: false
    name: virt7-docker-common-release
    baseurl: http://cbs.centos.org/repos/virt7-docker-common-release/x86_64/os/
    state: present
    description: Kubernetes repository

- name: install kubernetes basics
  yum:
    name: "{{ item }}"
    state: present
  with_items:
    - kubernetes
    - etcd
    - flannel

- name: set etc hosts
  set_fact:
    _hosts: "{{ _hosts + [item] }}"
  with_items: "{{ groups['kubernetes_master'] }}"

- name: set etc hosts
  set_fact:
    _hosts: "{{ _hosts + [item] }}"
  with_items: "{{ groups['kubernetes_slave'] }}"
  when: "{{ groups['kubernetes_slave'] is defined }}"

- name: add hosts to /etc/hosts
  lineinfile:
    line: "{{ kubernetes_private_ip }} {{ hostvars[item]['inventory_hostname'] }}"
    state: present
    dest: /etc/hosts
  with_items: "{{ groups['kubernetes_master'] + groups['kubernetes_slave'] }}"

- name: drop in kubernetes config
  template:
    src: kubernetes_config.j2
    dest: /etc/kubernetes/config
    owner: root
    mode: 0644

- name: stop firewalld
  service:
    name: "{{ item }}"
    state: stopped
    enabled: false
  with_items:
    - firewalld
